<html>
    <head>
        <meta charset="utf-8">
        <title>Andrew's emulator</title>
    </head>
    <body>
        <h1>Andrews emulator</h1>
        <div id="termDiv" ></div>
        <button type="button" onclick="javascript:startEmulator('kern.srec')">Start!</button> 
    </body>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="termlib.js"></script>
  <script type="text/javascript">
        var term;
        Module = {}
        Module.print = function (s) {
           if ((!term) || (term.closed)) {
                return;
            }
            term.write(s);
        }
        Module.noInitialRun = true; // nothing to run
  </script>
  <script type="text/javascript" src="ememu.js"></script>
  <script type="text/javascript">

    
    new_mips  = Module.cwrap('new_mips', 'number', ['number']);
    free_mips = Module.cwrap('free_mips', 'void', ['number']);
    step_mips = Module.cwrap('step_mips', 'void', ['number']);  
    loadSrecFromString_mips = Module.cwrap('loadSrecFromString_mips', 'number', ['number','string']); 
    
    
    
    function resetTerminal() {
        if ((!term) || (term.closed)) {
            termOpen();
        } else {
            term.reset();
        }
    }
    
    function putTerminalText(s) {
        if ((!term) || (term.closed)) {
            alert(s);
            return;
        }
        term.write(s + '\n');
    }
    
    function termInit() {
        // intentionally blank
    }
    
    function termHandler() {
    
    
    }
    
    
    function termOpen() {
	    if ((!term) || (term.closed)) {
		    term = new Terminal(
			    {
				    cols: 90,
				    rows: 30,
				    ps: '',
				    termDiv: 'termDiv',
				    initHandler : termInit,
				    handler: termHandler,
				    //exitHandler: termExitHandler
			    }
		    );
		    term.wrapOn();
		    term.charMode = true;
		    term.open();
	    }
    }
    curEmu = {}
    curEmu.isLoading = false;
    
    
    
    function startEmulator(srec) {
        
        if(curEmu.isLoading) {
            putTerminalText("emulator currently downloading image...");
            return
        }
        
        if (curEmu.handle != undefined) {
            putTerminalText("freeing existing emulator...");
            free_mips(curEmu.handle);
        }
        putTerminalText("allocating new emulator...");
        curEmu.handle = new_mips(64*1024*1024);
        if(curEmu.handle == 0){
            curEmu.handle = undefined;
            putTerminalText("failed to allocate new mips emulator");
        }
        curEmu.isLoading = true;
        $.ajax({
            url : "/srecs/" + srec,
            success : function(result){
                curEmu.isLoading = false;
                var err = loadSrecFromString_mips(curEmu.handle,result);
        
                if(err) {
                    putTerminalText("failed to load srec! (corrupt or something)");
                    free_mips(curEmu.handle);
                    curEmu.handle = undefined;
                    return;
                }
                
                putTerminalText("loaded " + srec);
                
                setInterval(function() {
                                for(var i = 0; i < 5000; i++) {
                                    step_mips(curEmu.handle);
                                }
                            },0);
                
            },
            
            error: function() {
                curEmu.isLoading = false;
                putTerminalText("image download failed.");
            }
        });
    }
    
    
    
    </script>

    
    
    <body onload="termOpen();">
    <style type="text/css">
      .term {
            font-family: courier,fixed,swiss,sans-serif;
            font-size: 12px;
            color: #2DFF00;
            background: none;
        }

        .termReverse {
            color: #111111;
            background: #2DFF00;
        }
        
    </style>
</html>
